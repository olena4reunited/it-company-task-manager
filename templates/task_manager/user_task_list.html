{% extends "base.html" %}
{% load tz %}

{% block title %}
  <title>{{ user.username }}'s Task Dashboard</title>
{% endblock %}

{% block content %}
  {% now "Y-m-d" as today %}
  <div class="container my-5">
    <h1 class="text-center mb-4">{{ user.first_name }} {{ user.last_name }}'s Task Dashboard</h1>
    
    <div class="row mb-4">
      <div class="col-md-6">
        <form method="get" class="d-flex">
          <input type="text" name="task_type_name" class="form-control me-2" placeholder="Search by Task Type" value="{{ task_type_name }}">
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
      </div>
      <div class="col-md-6 text-end">
        <a href="{% url 'task-manager:task-create' %}" class="btn btn-success">
          <i class="fas fa-plus-circle me-2"></i>Create New Task
        </a>
      </div>
    </div>

    <div class="row">
      <div class="col-md-9">
        <div class="row">
          {% for task in tasks %}
            {% localtime on %}
              {% with task_deadline=task.deadline|date:"Y-m-d" %}
                <div class="col-md-6 mb-4">
                  <div class="card h-100 {% if task.is_completed %}border-success{% else %}border-warning{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">{{ task.name }}</h5>
                      <span class="badge {% if task.is_completed %}bg-success{% else %}bg-warning{% endif %}">
                        {% if task.is_completed %}
                          Completed
                        {% else %}
                          Due: {{ task.deadline|date:"M d, Y" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="card-body">
                      <h6 class="card-subtitle mb-2 text-muted">{{ task.task_type.name }}</h6>
                      <p class="card-text">{{ task.description|truncatechars:100 }}</p>
                      <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'task-manager:task-detail' pk=task.id %}" class="btn btn-info btn-sm">
                          <i class="fas fa-eye me-1"></i>Details
                        </a>
                        {% if request.user == task.created_by %}
                          <div>
                            <a href="{% url 'task-manager:task-update' pk=task.id %}" class="btn btn-primary btn-sm me-2">
                              <i class="fas fa-edit me-1"></i>Update
                            </a>
                            <a href="{% url 'task-manager:task-delete' pk=task.id %}" class="btn btn-danger btn-sm">
                              <i class="fas fa-trash-alt me-1"></i>Delete
                            </a>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              {% endwith %}
            {% endlocaltime %}
          {% empty %}
            <div class="col-12">
              <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading">No tasks found</h5>
                <p class="mb-0">Create a new task to get started!</p>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
